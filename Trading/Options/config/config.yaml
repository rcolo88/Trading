# Options Backtesting Configuration

# Target underlying asset
underlying:
  symbol: SPY
  name: "SPDR S&P 500 ETF Trust"

# Backtesting period
backtest:
  start_date: "2025-01-03"  # Matches synthetic data start date
  end_date: "2025-11-17"    # Matches synthetic data end date
  initial_capital: 10000

# Data source configuration
data_source:
  primary: "quantconnect"  # Options: quantconnect, yahoo, polygon, schwab
  backup: "yahoo"  # For underlying price data
  cache_enabled: true
  cache_dir: "data/processed"

# Transaction costs
costs:
  commission_per_contract: 0.65  # Per contract per side
  slippage_percent: 0.02  # 2% slippage estimate
  bid_ask_spread_percent: 0.02  # 2% bid-ask spread estimate

# Strategy parameters
strategies:
  bull_put_spread:          # Credit spread - neutral to bullish
    enabled: true
    entry:
      dte_min: 50           # Days to expiration
      dte_max: 60
      short_delta: 0.20     # Sell put with ~30 delta
      long_delta: 0.10      # Buy put with ~20 delta
      iv_percentile_min: 60 # Enter when IV is above 30th percentile (higher premium)
      iv_percentile_max: 150 # Don't enter if IV > 80th percentile (too risky)
    exit:
      profit_target: 0.50   # Close at 50% of max profit
      stop_loss: 0.10       # Stop at 50% of max loss
      dte_min: 21           # Close if DTE drops below 21

  bull_call_spread:         # Debit spread - moderately bullish
    enabled: true
    entry:
      dte_min: 30
      dte_max: 60
      long_delta: 0.60      # Buy call with ~60 delta
      short_delta: 0.60     # Sell call with ~40 delta
      iv_percentile_min: 0 # Can enter in lower IV percentile (cheaper debit)
      iv_percentile_max: 40 # Don't enter if IV > 70th percentile (too expensive)
    exit:
      profit_target: 0.75   # Target 75% of max profit
      stop_loss: 0.20       # Stop at 50% of max loss
      dte_min: 14

  call_calendar:            # Time spread - neutral to slightly bullish
    enabled: true
    entry:
      # DTE Configuration - Two approaches supported:
      # Approach 1 (Default): Center ± Tolerance
      near_dte: 20           # Sell 30 DTE call (center point)
      far_dte: 45            # Buy 60 DTE call (center point)
      dte_tolerance: 5       # +/- 5 days tolerance (creates range: 25-35 and 55-65)

      # Approach 2 (For Optimizer): Min/Max Ranges
      # Uncomment to use explicit ranges instead of center ± tolerance:
      # near_dte_min: 25      # Minimum DTE for near-term leg
      # near_dte_max: 35      # Maximum DTE for near-term leg
      # far_dte_min: 55       # Minimum DTE for far-term leg
      # far_dte_max: 65       # Maximum DTE for far-term leg
      # Note: If min/max specified, they override near_dte/far_dte/dte_tolerance

      strike_selection: "atm"  # Options: atm, delta, moneyness
      target_delta: 0.50     # Used if strike_selection = "delta"
      moneyness: 0.0         # Used if strike_selection = "moneyness" (0.0 = ATM)
      min_debit: 0.5         # Minimum debit to enter (optional)
      max_debit: 28.0        # Maximum debit to enter (increased for SPY ~$530)
      iv_percentile_min: 0  # Calendars prefer low IV environment (10th percentile+)
      iv_percentile_max: 60  # Don't enter if IV > 50th percentile (defeats calendar purpose)
    exit:
      profit_target: 0.6    # Close at 60% profit
      stop_loss: -0.1       # Stop at 10% loss
      dte_exit: 1            # Exit when near-term has 7 DTE left
      max_underlying_move: 0.10  # Exit if underlying moves >10% from strike

  iron_condor:              # Market-neutral credit spread - high IV strategy
    enabled: true
    entry:
      # Time parameters
      dte_min: 30
      dte_max: 45

      # Put spread (below current price)
      put_short_delta: 0.20    # Sell put ~20 delta
      put_long_delta: 0.10     # Buy put ~10 delta

      # Call spread (above current price)
      call_short_delta: 0.20   # Sell call ~20 delta
      call_long_delta: 0.10    # Buy call ~10 delta

      # IV Percentile filters (HIGH IV environment)
      iv_percentile_min: 60    # Only enter when IV elevated
      iv_percentile_max: 85    # Avoid extreme volatility

      # Credit/risk requirements
      min_credit: 1.50         # Minimum total credit to enter
      max_wing_width: 10.0     # Maximum strike width (risk control)

    exit:
      profit_target: 0.50      # Close at 50% max profit
      stop_loss: 0.75          # Stop at 75% max loss
      dte_min: 14              # Exit with 14 DTE remaining
      breach_threshold: 0.02   # Exit if price within 2% of short strike

# Position sizing
position_sizing:
  method: "fixed_risk"  # Options: fixed_risk, kelly
  max_risk_percent: 50.0  # Maximum portfolio risk exposure (% of current portfolio value)

  # Kelly Criterion percentages (manually updated from Kelly_Criteria notebook)
  # Workflow:
  #   1. Run backtest → 2. Calculate Kelly in notebook → 3. Update values below
  # Important: Use Half Kelly (multiply by 0.5) or Quarter Kelly (multiply by 0.25)
  kelly_pct:
    bull_put_spread: 0.06    # Example: 6% (Half Kelly of 12%)
    bull_call_spread: 0.04   # Example: 4% (Half Kelly of 8%)
    call_calendar: 0.05      # Example: 5% (Half Kelly of 10%)
    iron_condor: 0.05        # Example: 5% (Half Kelly of 10%)

# Market filters (global fallback - each strategy has its own IV Percentile criteria in entry section)
market_filters:
  iv_percentile_max: 75  # Global fallback: Don't enter if IV Percentile > 75
  iv_percentile_min: 25  # Global fallback: Don't enter if IV Percentile < 25

# Analysis and reporting
analysis:
  metrics:
    - "total_pnl"
    - "annualized_return"
    - "win_rate"
    - "profit_factor"
    - "max_drawdown"
    - "sharpe_ratio"
    - "calmar_ratio"
    - "average_win"
    - "average_loss"
    - "trade_count"

  visualization:
    plot_equity_curve: true
    plot_drawdown: true
    plot_monthly_returns: true
    plot_greeks_exposure: true

# Logging
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  file: "logs/backtest.log"
  console: true
